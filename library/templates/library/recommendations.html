{% extends "library/base.html" %}
{% block title %}Recommendations - Bookstore{% endblock %}

{% block content %}

<!-- Title + back button -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Recommendations for you</h1>
    <a href="{% url 'library:home' %}" class="btn btn-outline-secondary btn-sm">
        ‚Üê Back to Home
    </a>
</div>

<!-- Metric + k-neighbours controls -->
<div class="d-flex align-items-center gap-3 mb-3">

    <!-- Similarity metric badge -->
    <span class="badge bg-primary">Metric: {{ metric }}</span>

    <!-- Neighbourhood size dropdown (k neighbours) -->
    <div class="dropdown">
        <button class="btn btn-outline-dark btn-sm dropdown-toggle"
                type="button"
                id="kMenu"
                data-bs-toggle="dropdown"
                aria-expanded="false">
            {% if k_value %}
                {% if k_value == 1 %}
                    Most similar user (k = 1)
                {% else %}
                    Top {{ k_value }} users (k = {{ k_value }})
                {% endif %}
            {% else %}
                Widest pool (all users, k = all)
            {% endif %}
        </button>

        <ul class="dropdown-menu" aria-labelledby="kMenu">
            <li>
                <a class="dropdown-item k-option" href="?metric={{ metric }}&k=">
                    Widest pool (all users) <small class="text-muted">(k = all)</small>
                </a>
            </li>
            <li>
                <a class="dropdown-item k-option" href="?metric={{ metric }}&k=10">
                    Top 10 similar users <small class="text-muted">(k = 10)</small>
                </a>
            </li>
            <li>
                <a class="dropdown-item k-option" href="?metric={{ metric }}&k=5">
                    Top 5 similar users <small class="text-muted">(k = 5)</small>
                </a>
            </li>
            <li>
                <a class="dropdown-item k-option" href="?metric={{ metric }}&k=3">
                    Top 3 similar users <small class="text-muted">(k = 3)</small>
                </a>
            </li>
            <li>
                <a class="dropdown-item k-option" href="?metric={{ metric }}&k=2">
                    Top 2 similar users <small class="text-muted">(k = 2)</small>
                </a>
            </li>
            <li>
                <a class="dropdown-item k-option" href="?metric={{ metric }}&k=1">
                    Most similar user only <small class="text-muted">(k = 1)</small>
                </a>
            </li>
        </ul>
    </div>

    <!-- Tooltip explanation -->
    <span class="text-muted small"
          data-bs-toggle="tooltip"
          title="Neighbourhood size controls how many similar users the algorithm looks at. Smaller = more personalised, larger = broader suggestions.">
        <i class="bi bi-info-circle"></i> What is this?
    </span>

    <!-- Tiny spinner shown while AJAX reloads -->
    <div id="k-spinner" class="spinner-border spinner-border-sm text-secondary d-none ms-2" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Container that will be replaced via AJAX -->
<div id="recs-container">
    {% include "library/_recommendations_partial.html" %}
</div>

<!-- AJAX script to update recommendations when k changes -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Enable Bootstrap tooltips (if not already done in base.html)
    if (window.bootstrap && bootstrap.Tooltip) {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    const container = document.getElementById('recs-container');
    const spinner = document.getElementById('k-spinner');
    const kButton = document.getElementById('kMenu');
    const kLinks = document.querySelectorAll('.dropdown-item.k-option');

    if (!container) return;

    kLinks.forEach(function (link) {
        link.addEventListener('click', function (e) {
            e.preventDefault();

            // Build URL and add partial=1 so view returns only the fragment
            const url = new URL(this.href, window.location.origin);
            url.searchParams.set('partial', '1');

            const labelHtml = this.innerHTML; // to update button text later

            // Simple fade + spinner
            container.style.opacity = '0.4';
            if (spinner) spinner.classList.remove('d-none');

            fetch(url)
                .then(function (response) { return response.text(); })
                .then(function (html) {
                    container.innerHTML = html;
                    // Update button label to match chosen option
                    if (kButton) {
                        kButton.innerHTML = labelHtml;
                    }
                })
                .catch(function (err) {
                    console.error('Error loading recommendations:', err);
                })
                .finally(function () {
                    container.style.opacity = '1';
                    if (spinner) spinner.classList.add('d-none');
                });
        });
    });
});
</script>

{% endblock %}
